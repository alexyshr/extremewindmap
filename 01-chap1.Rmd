<!--
This is for including Chapter 1.  Notice that it's also good practice to name your chunk.  This will help you debug potential issues as you knit.  The chunk above is called intro and the one below is called chapter1.  Feel free to change the name of the Rmd file as you wish, but don't forget to change it here from chap1.Rmd.
-->

<!--
The {#rmd-data} text after the chapter declaration will allow us to link throughout the document back to the beginning of Chapter 1.  These labels will automatically be generated (if not specified) by changing the spaces to hyphens and capital letters to lowercase.  Look for the reference to this label at the beginning of Chapter 2.
-->

```{r wrap-hook}
library(knitr)
hook_output = knit_hooks$get('output')
knit_hooks$set(output = function(x, options) {
  # this hook is used only when the linewidth option is not NULL
  if (!is.null(n <- options$linewidth)) {
    x = knitr:::split_lines(x)
    # any lines wider than n should be wrapped
    if (any(nchar(x) > n)) x = strwrap(x, width = n)
    x = paste(x, collapse = '\n')
  }
  hook_output(x, options)
})
```


```{r load_pkgs, message=FALSE}
# List of packages required for this analysis
pkg <- c("dplyr", "sf", "ggplot2","rnaturalearth", "rnaturalearthdata", 
         "ggspatial", "kableExtra", "ncdf4", "stars", "magick", "RcmdrMisc",
         "knitr", "bookdown", "devtools")
# Check if packages are not installed and assign the
# names of the packages not installed to the variable new.pkg
new.pkg <- pkg[!(pkg %in% installed.packages())]
# If there are any packages in the list that aren't installed,
# install them
if (length(new.pkg))
  install.packages(new.pkg, repos = "http://cran.rstudio.com")
# Load packages (thesisdown will load all of the packages as well)
library("thesisdown")
library("dplyr")
library("sf")
library("ggplot2")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
#library("tibble")
library("knitr")
library("kableExtra")
library("ncdf4")
library("stars")
library("magick")
library("RcmdrMisc")
```


```{r include=FALSE}
#message=FALSE, warning=FALSE
#echo=FALSE, cache=TRUE, warnings=FALSE, messages=FALSE, error=FALSE
#include=FALSE, echo=FALSE, cache=TRUE, warnings=FALSE, messages=FALSE, error=FALSE, results="hide"
#Conect PostgreSql

con1 = src_postgres(dbname = "winddata", host = "localhost", port = 5432, user = "user1", password = "user1")

#Get Ideam Stations Table
originalfields4 = c("objectid", "codigo1", "nombre", "latitud", "longitud", "categoria")
originalfields4 = paste(originalfields4, collapse= ", ", sep = "")
query4 = paste("select", originalfields4, "from ideam_all_stations", "where inpqrs2 = 'YES'", sep=" ")
ideam_stations = as_tibble(tbl(con1, sql(query4)))
Encoding(ideam_stations$categoria) <- "UTF-8"
Encoding(ideam_stations$nombre) <- "UTF-8"

originalfields3 = c("id", "usaf", "station_name", "latitud", "longitud")
originalfields3 = paste(originalfields3, collapse= ", ", sep = "")
query3 = paste("select", originalfields3, "from isd_all_stations where usaf_isd_dataua != ''", sep=" ")
isd_stations = as_tibble(tbl(con1, sql(query3)))
```

# Data {#rmd-data}

Input data is made up of three different sources a) IDEAM - Institute of Hydrology, Meteorology and Environmental Studies of Colombia <http://www.ideam.gov.co>, b) ISD - Integrated Surface Database <https://www.ncdc.noaa.gov/isd>, and c) ERA5 climate reanalysis <https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5>. 

```{r tabledatasources1, echo= F, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
data_sources_thesis_summary1 <-read.csv("./data/data_sources_thesis_summary1.csv",header=TRUE, stringsAsFactors = F)

kable(data_sources_thesis_summary1, align=rep('l', 3),
      #col.names = c("Name[Code]", "Latitud", "Longitud"),
      caption = "Datasets description",
      caption.short = "Datasets",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(2,width = "0.8in") %>%
      column_spec(3,width = "4in") %>%
kable_styling(font_size = 10, latex_options="scale_down")

```

```{r tabledatasources2, echo= F, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
data_sources_thesis_summary2 <-read.csv("./data/data_sources_thesis_summary2.csv",header=TRUE, stringsAsFactors = F)

kable(data_sources_thesis_summary2, align=rep('l', 3),
      #col.names = c("Name[Code]", "Latitud", "Longitud"),
      caption = "Datasets variables",
      caption.short = "Variables",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(2,width = "1.2in") %>%
      column_spec(3,width = "3.5in") %>%
kable_styling(font_size = 10, latex_options="scale_down")

```

```{r tabledatasources3, echo= F, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
data_sources_thesis_summary3 <-read.csv("./data/data_sources_thesis_summary3.csv",header=TRUE, stringsAsFactors = F)

kable(data_sources_thesis_summary3, align=rep('l', 4),
      #col.names = c("Name[Code]", "Latitud", "Longitud"),
      caption = "Variables units and time",
      caption.short = "Units and Time",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(2,width = "0.8in") %>%
      column_spec(3,width = "3in") %>%
kable_styling(font_size = 10, latex_options="scale_down")
```

Ideal data source to create extreme wind speeds maps should be field observed data from IDEAM, but there are not enough number of stations around the study area to represent all the local wind variability in a huge country with multiple variety of climates and and changing thermal floors, but there are other important motivatios to include different sources trying to improve output results:

* As just mentioned, low quantity of IDEAM stations
* There are uncertanties related to the way IDEAM anemometers are registering data, then comparison with other datasources are needed to be able to do appropriate data standardization, needed as a prerequisite to the analysis.
* There is no time continuity in the registration of IDEAM data. Historical time series are different and variable in each station.

Importance of ISD database for this study is based on the fact that post-procesed ISD database has wind extreme values, and it was used to create extreme wind maps for United States. ISD allows comparison with IDEAM records to take better decitions in order to do needed data standarization.

Despite that ERA5 data are not observed data, but forecast, its main advantage is data availability to assess the local climatic variance every 33 square kilometers.


## IDEAM

**R**


* Item 1
* Item 2


1. Item 1
4. Item 2


1. Item 1
1. Item 2
1. Item 3
    - Item 3a
    - Item 3b

Historical observed wind speeds from `r length(ideam_stations$codigo1)` in Colombia are managed by the official environmental authority IDEAM. Table \@ref(tab:tableideamstations) shows a sample of five IDEAM stations. Figure \@ref(fig:plotideamstations) shows a map of IDEAM stations.

```{r tableideamstations, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
tableideam =  ideam_stations[c(81,120,200,57,179), c("nombre", "latitud", "longitud")]
tableideam$latitud = round(tableideam$latitud, 2)
tableideam$longitud = round(tableideam$longitud, 2)

#tableideamstations = 
kable(tableideam, 
      col.names = c("Name[Code]", "Latitud", "Longitud"),
      caption = "IDEAM Stations sample",
      caption.short = "IDEAM Stations",
      longtable = TRUE,
      booktabs = TRUE)

#kable_styling(tableideamstations, font_size = 10)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Create simple features from Ideam Stations
ideam_stations = st_as_sf(ideam_stations, coords = c("longitud", "latitud"), crs = 4326)
```

```{r plotideamstations, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="IDEAM Stations"}

#Maps of the World
theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))


colombia = world_points$name == "Colombia"
panama = world_points$name == "Panama"
peru= world_points$name == "Peru"
brazil= world_points$name == "Brazil"
venezuela= world_points$name == "Venezuela"
ecuador= world_points$name == "Ecuador"

ggplot(data = world) + 
  geom_sf(fill= "antiquewhite") + 
  #geom_text(data= world_points,aes(x=X, y=Y, label=name), color = "darkblue", fontface = "bold", check_overlap = FALSE) +
  geom_text(data= world_points[venezuela,],aes(x=-67, y=8.5, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[panama,],aes(x=-79.2, y=9.2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) + 
  geom_text(data= world_points[ecuador,],aes(x=-78.2, y=-1, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[peru,],aes(x=-75, y=-4, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[brazil,],aes(x=-67, y=-2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  annotate(geom = "text", x = -77.5, y = 13, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  annotate(geom = "text", x = -80, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
  geom_sf(data = ideam_stations, size=1, aes(shape=categoria, color=categoria), show.legend = "point") + 
  scale_color_discrete(name = 'Category', labels = c("Agrometeorological", "Ordinary Climatic", "Main Climatic", "Mareographic", "Special Meteorological", "Main Synoptic")) +
  scale_shape_discrete(name = 'Category', labels = c("Agrometeorological", "Ordinary Climatic", "Main Climatic", "Mareographic", "Special Meteorological", "Main Synoptic")) +  
  annotation_scale(location = "bl", width_hint = 0.5) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-82.1, -63.8), ylim = c(-7.5, 15.5), expand = FALSE) +
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle("IDEAM Stations") + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"))
```

Following, the time serie, autocorrelation function, and partial autocorrelation function, for IDEAM station "21205791" will be displayed.

```{r plotoneideamstation, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="IDEAM Station - Time Serie"}
#originalfields = unique(era5_intersect_ideam["ideam",])
originalfields = c("21205791")
newfields = paste ("X", originalfields, sep="")
originalfields = paste('"', originalfields, '"', sep = "")
newfields = paste('"', newfields, '"', sep = "")
#fiedls_query = paste("CASE WHEN", originalfields, "> 55.5", "THEN NULL ELSE", originalfields, "END", newfields, sep = " ")
fiedls_query = paste(originalfields, "as", newfields, sep = " ")
fiedls_query = c(paste('"', "mydatetime", '"', sep = ""), fiedls_query)
fiedls_query = paste (fiedls_query, "", sep= "", collapse=", ")

#wherestring = unique(era5_intersect_ideam["ideam",])
wherestring = c("21205791")
wherestring = paste('"', wherestring, '"', sep = "")
wherestring = paste(wherestring, "IS NOT NULL", sep = " ")
wherestring = paste(wherestring, collapse = " OR " , sep = " ")
query = paste("select", fiedls_query, "from ideam_vvmx_60", "where", wherestring, sep=" ")
#cat(query)
all_vvmx_aut_60 = as_tibble(tbl(con1, sql(query)))
timestamp_all_vvmx_aut_60 <- as.POSIXct(as_tibble(select(all_vvmx_aut_60, mydatetime))$mydatetime,format="%Y-%m-%d %H:%M:%S", tz="UTC")
library(xts)
statideam_xts = na.omit(xts(x=select(all_vvmx_aut_60, "X21205791"), order.by = timestamp_all_vvmx_aut_60))
par(oma = c(2,0,0,0))
plot.xts(statideam_xts, main = "Station ID: 21205791\nWind Velocity [m/s]", major.ticks="years", format.labels = "%b-%d\n%Y", legend.loc = "top", col="green", cex.main=0.2)
mtext(side = 1, text = "Station Name: ELDORADO CATAM - AUT", outer = TRUE)
```

```{r plotoneideamstationacf, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="IDEAM Station ACF"}
par(oma = c(0,0,0,0))
myacf = acf(statideam_xts[,1][!is.na(statideam_xts[,1])], plot=FALSE)
titleacf = paste("Auto-Correlation Function - ACF", paste("IDEAM", "21205791", sep = ":"), sep = "\n")
plot(myacf, main = titleacf)
```

```{r plotoneideamstationpacf, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="IDEAM Station PACF"}
par(oma = c(0,0,0,0))
mypacf = pacf(statideam_xts[,1][!is.na(statideam_xts[,1])], plot=FALSE)
titlepacf = paste("Partial Auto-Correlation Function - PACF", paste("IDEAM", "21205791", sep = ":"), sep = "\n")
plot(mypacf, main = titlepacf)
```




## ISD

*Now for the correct way:* 
ISD is a database with environmental variables among then extreme wind speeds. ISD has data for the whole planet, and is based on observed data at metereological stations in each country, which means that for Colombia is based on IDEAM data. Main advantage is data availability at neighbor countries and specialized postprocesing made by NOAA's National Centers for Environmental Information - NCEI in United States, which facilitates its use.Table \@ref(tab:tableisdstations) shows a sample of five ISD stations. Figure \@ref(fig:plotisdstations) shows a map of ISD stations.

```{r tableisdstations, echo=FALSE, message=FALSE, warning=FALSE, results="asis"}
tableisd =  isd_stations[c(81,20,29,57,60), c("usaf", "station_name", "latitud", "longitud")]
tableisd$latitud = round(tableisd$latitud, 2)
tableisd$longitud = round(tableisd$longitud, 2)

#tableideamstations = 
kable(tableisd, 
      col.names = c("Code", "Name", "Latitud", "Longitud"),
      caption = "ISD Stations sample",
      caption.short = "ISD Stations",
      longtable = TRUE,
      booktabs = TRUE)

#kable_styling(tableideamstations, font_size = 10)

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Create simple features from Ideam Stations
isd_stations = st_as_sf(isd_stations, coords = c("longitud", "latitud"), crs = 4326)
```

```{r plotisdstations, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="ISD Stations"}

#Maps of the World
theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))


colombia = world_points$name == "Colombia"
panama = world_points$name == "Panama"
peru= world_points$name == "Peru"
brazil= world_points$name == "Brazil"
venezuela= world_points$name == "Venezuela"
ecuador= world_points$name == "Ecuador"

ggplot(data = world) + 
  geom_sf(fill= "antiquewhite") + 
  #geom_text(data= world_points,aes(x=X, y=Y, label=name), color = "darkblue", fontface = "bold", check_overlap = FALSE) +
  geom_text(data= world_points[venezuela,],aes(x=-67, y=8.5, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[panama,],aes(x=-79.2, y=9.2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) + 
  geom_text(data= world_points[ecuador,],aes(x=-78.2, y=-1, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[peru,],aes(x=-75, y=-4, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[brazil,],aes(x=-67, y=-2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  annotate(geom = "text", x = -77.5, y = 13, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  annotate(geom = "text", x = -80, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
  geom_sf(data = isd_stations, size=1, shape=2, color= "black", show.legend = "point") + 
  annotation_scale(location = "bl", width_hint = 0.5) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-82.1, -63.8), ylim = c(-7.5, 15.5), expand = FALSE) +
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle("ISD Stations") + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"))
```

Following, the time serie, autocorrelation function, and partial autocorrelation function, for ISD station "802590" will be displayed.

```{r plotoneisdstation, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="ISD Station - Time Serie"}
#originalfields1 = unique(era5_intersect_isd["usaf",])
originalfields1 = c("802590")
newfields1 = paste ("X", originalfields1, sep="")
originalfields1 = paste('"', originalfields1, '"', sep = "")
newfields1 = paste('"', newfields1, '"', sep = "")
fiedls_query1 = paste(originalfields1, "as", newfields1, sep = " ")
fiedls_query1 = c(paste('"', "mydatetime", '"', sep = ""), fiedls_query1)
fiedls_query1 = paste (fiedls_query1, "", sep= "", collapse=", ")
#wherestring1 = unique(era5_intersect_isd["usaf",])
wherestring1 = c("802590")
wherestring1 = paste('"', wherestring1, '"', sep = "")
wherestring1 = paste(wherestring1, "IS NOT NULL", sep = " ")
wherestring1 = paste(wherestring1, collapse = " OR " , sep = " ")
query1 = paste("select", fiedls_query1, "from isd_lite_unstack", "where", wherestring1, sep=" ")
cat(query1)

isdlite = as_tibble(tbl(con1, sql(query1)))

timestamp_isdlite <- as.POSIXct(as_tibble(select(isdlite, mydatetime))$mydatetime,format="%Y-%m-%d %H:%M:%S", tz="UTC")
library(xts)
statisd_xts = na.omit(xts(x=select(isdlite, "X802590"), order.by = timestamp_isdlite))
par(oma = c(2,0,0,0))
plot.xts(statisd_xts, main = "Station ID: 802590\nWind Velocity [m/s]", major.ticks="years", format.labels = "%b-%d\n%Y", legend.loc = "top", col="green", cex.main=0.2)
mtext(side = 1, text = "Station Name: ALFONSO BONILLA ARAGON INTL", outer = TRUE)
```

```{r plotoneisdstationacf, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="ISD Station ACF"}
par(oma = c(0,0,0,0))
myacf = acf(statisd_xts[,1][!is.na(statisd_xts[,1])], plot=FALSE)
titleacf = paste("Auto-Correlation Function - ACF", paste("ISD", "802590", sep = ":"), sep = "\n")
plot(myacf, main = titleacf)
```

```{r plotoneisdstationpacf, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="IDEAM Station PACF"}
par(oma = c(0,0,0,0))
mypacf = pacf(statisd_xts[,1][!is.na(statisd_xts[,1])], plot=FALSE)
titlepacf = paste("Partial Auto-Correlation Function - PACF", paste("ISD", "802590", sep = ":"), sep = "\n")
plot(mypacf, main = titlepacf)
```


## ERA5

```{r include=FALSE}
ncname <- "outfile_nc4c_zip9"
filename <- paste("./data/", ncname, ".nc", sep = "")
ncin <- nc_open(filename)
#print (ncin)
lon <- ncvar_get(ncin, "longitude")
#lon
nlon = dim(lon)
#nlon
lat <- ncvar_get(ncin, "latitude")
#lat
nlat = dim(lat)
#nlat
ntime <-  dim(ncvar_get(ncin, "time"))
variablename <- "fg10"
fg10.units <- ncatt_get(ncin, variablename, "units")
fg10.units
lonlat.unstack <- expand.grid(lon=as.numeric(lon), lat=as.numeric(lat))
```


```{r, include=FALSE}
#Create point sf with lat and lon and value as cell index
era5colpoints = st_as_sf(lonlat.unstack, coords=1:2, crs=st_crs(4326))
era5colpoints$value = 1:(nlon*nlat)
#str(era5colpoints)
#plot(era5colpoints)
```

```{r, include=FALSE}
pointsbbox = st_bbox(era5colpoints)
cellsize = lonlat.unstack$lon[2]- lonlat.unstack$lon[1]
mybbox = st_bbox(c(pointsbbox$xmin - (cellsize/2), pointsbbox$xmax + (cellsize/2), pointsbbox$ymax + (cellsize/2), pointsbbox$ymin - (cellsize/2)), crs = st_crs(4326))
era5colraster.st = st_rasterize(era5colpoints, st_as_stars(mybbox, nx = nlon, ny = nlat, values = era5colpoints$value))
```


ERA5 is forecast reanalysis data procesed by the _European Centre for Medium-Range Weather Forecasts_ - ECMWF with wind speeds time series in square cells _matrix of pixels_ of 0.25 degrees (33 km) covering the whole plannet. For the study area was extracted a raster of `r (nlat)` rows by `r nlon` XXX columns in format NetCDF. Figure \@ref(fig:plotera5stations) shows a map of ERA5 stations (cells centers).

```{r plotera5stations, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="ERA5 Stations (cells centers)"}

#Maps of the World
theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))


colombia = world_points$name == "Colombia"
panama = world_points$name == "Panama"
peru= world_points$name == "Peru"
brazil= world_points$name == "Brazil"
venezuela= world_points$name == "Venezuela"
ecuador= world_points$name == "Ecuador"

ggplot(data = world) + 
  geom_sf(fill= "antiquewhite") +
  geom_sf(data=era5colpoints, size=0.1, color = "black", shape=".")+
  #geom_text(data= world_points,aes(x=X, y=Y, label=name), color = "darkblue", fontface = "bold", check_overlap = FALSE) +
  #annotate("label", x = max(grossunits), y = meancbrate, label = "avg rate")
  geom_text(data= world_points[venezuela,],aes(x=-66, y=8.5, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[panama,],aes(x=-80.5, y=9.2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) + 
  geom_text(data= world_points[ecuador,],aes(x=-79.5, y=-1.5, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[peru,],aes(x=-75.5, y=-5.2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[brazil,],aes(x=-65, y=-2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  #geom_text( x = -77.5, y = 13, label = "Caribbean Sea", fontface = "italic", color = "grey22", size = 4)+
  annotate(geom = "text", x = -77.5, y = 14, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  #geom_text(x = -80, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) + 
  annotate(geom = "text", x = -80.5, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
#  geom_stars(data = era5colraster.st) + #, size=1, shape=2, color= "black", show.legend = "point") + 
  annotation_scale(location = "bl", width_hint = 0.5) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), style = north_arrow_fancy_orienteering) + 
  coord_sf(xlim = c(-82.1, -63.8), ylim = c(-7.5, 15.5), expand = FALSE) +
  xlab("Longitude") + 
  ylab("Latitude") + 
  ggtitle("ERA5 Stations") + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"))
```

```{r, include=FALSE}
t.units <- ncatt_get(ncin, "time", "units")
t.units
time.array <-  ncvar_get(ncin, "time")
nt = dim(time.array)
nt
head(time.array, 1)
tail(time.array, 1)
tustr <- strsplit(t.units$value, " ")
#tustr
#Our data is in Gregorian Calendar: "hours"      "since"      "1900-01-01" "00:00:00.0"
anio_mes_dia = unlist(tustr)[3]
anio_mes_dia
#Note that the dates are converted first to seconds!
library(lubridate)
timestamp = as_datetime(c(time.array*60*60),origin=anio_mes_dia)
timestamp_string <- as.character(timestamp)
#str(timestamp_string)
  statera5_xts = na.omit(xts(x= ncvar_get(ncin, 'fg10', start=c(1,1,1), count=c(1,1,ntime)), order.by = timestamp))
  colnames(statera5_xts) = paste0("ERA5_", "1")
  
```

## 





## Data Download and Organization


## Data Standarzation

Analysis of extreme wind speeds requieres data standarizaton as initial step. All input data must be standarized to represent three important conditions: a) anemometer height of 10 meters, b) open space roughness, and c) averaging time of 3-seconds wind gust. Data for analysis must represent 3-s peak wind speeds 10 meters heigh above the surface, in open terrain.
* 10 mts anemometer height
* Open space terrain roughness
* 3-s gust averaging time

> The `cos` of $2 \pi$ is `r cos(2*pi)`. 



> The standard deviation of `speed` in `cars` is `r sd(cars$speed)`.


> `r ifelse(sd(cars$speed) < 6, "The standard deviation is less than 6.", "The standard deviation is equal to or greater than 6.")`


As you see with `$2 \pi$` above, mathematics can be added by surrounding the mathematical text with dollar signs.  More examples of this are in [Mathematics and Science] if you uncomment the code in [Math].  


      

 **_after_** you have run the **R** 
 
\clearpage


```{r include_packages_3, include = FALSE}
# This chunk ensures that the thesisdown package is
# installed and loaded. This thesisdown package includes
# the template files for the thesis and also two functions
# used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")
if(!require(dplyr))
    install.packages("dplyr", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("ggplot2", repos = "http://cran.rstudio.com")
if(!require(ggplot2))
    install.packages("bookdown", repos = "http://cran.rstudio.com")
if(!require(thesisdown)){
  library(devtools)
  devtools::install_github("ismayc/thesisdown")
  }
library(thesisdown)
library(stars)
library(sf)
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
library(RColorBrewer)
library("knitr")
library("kableExtra")
library(raster)
library(RStoolbox)
library(gridExtra)
library(ggrepel)
library(dplyr)
library(grid)
library(gridExtra)
library(cowplot)
```

```{r echo=FALSE, cache= F, include=FALSE}
source('./code/pp_one_station.r')
```

```{r echo=FALSE, cache= F, include=FALSE}
#Important Note:
#This code is not working when knit. It is working if is ran here in RStudio, that is why next line is using # (not ran when knit). This code generates some graphis in format RDS. It is not neccesary to run again, at least RDS are not usable for changes in R versions (possible sittuacion for future)
#source('./code/comparing_sources_pqrs_20199050080932_VV_AUT.r')
```

# Results {#rmd-results}

In this section, will be shown first, the data source comparison (post standardization process) to face the downscaling issue by using ERA5 and ISD database, then, the resulting process of fitting a POT-PP in the ISD station 801120, which includes revision of intensity function parameters, goodness of fit, hazard curve, return levels, and comparison with POT-GPD results, next, non-hurricane maps outputs, which includes results for ISD and ERA5 stations, and finally, output maps combining hurricane and non-hurricane results will be displayed.

## Data Standardization and Downscaling Support

Looking for a statistical justification in the use of ISD (model) and ERA5 databases (forecast), as input data for this study, and considering the *downscaling approach* described in the [standartization process](#rmd-standartization) section of methodology, data sources ISD and IDEAM were standardized to enable comparison. Standardization consisted of transforming the data to be equivalent to $V_3$ 3-s gust, 10 meters anemometer height, and open space roughness. In the comparison process, for coincident stations by spatial location, it was checked if the velocity values (standardized) in the three sources, for equal dates, were similar in magnitude.

### Data Standardization

None of the sources required anemometer height standardization. @Lettau1969 was used for roughness standardization of ISD and IDEAM, applying the method station by station. Gust velocities standardization was done using Durst cuve, and in order to obtain $V_3$ from Durst curve, it was required to start from $V_{3600}$ (average hourly speed), or from a different wind gust speed, for instance $V_5$ 5-s gust.

For ERA5:

* Variable *10m wind gust - 10fg* of ERA5 data source does not need any standardization, because it comes standardized from the source.

For ISD:

* Wind velocity from ISD comes from source as $V_5$, that is, five seconds gust wind velocity. To standardize from $V_5$ to $V_3$, using Durst curve, the correction factor is 1.03.

* Wind velocity $V_5$ from 74 ISD stations, was standardized station by station, using procedure described in [Surface Roughness at Open Space](#rmd-roughness) section, and [Averaging Time 3-s Gust](#rmd-gust) section.

For IDEAM:

* As the original variables obtained from IDEAM, do not represent gust speeds, it was necessary to start from _average hourly speed_ $V_{3600}$, to obtain 3-s gust $V_3$. To standardize from $V_{3600}$ to $V_3$, using Durst curve, the correction factor is 1.51.

* It was not possible to obtain the _average hourly speed_ $V_{3600}$ from IDEAM, see table \@ref(tab:tabledatasources2), but from _instantaneous wind velocity each 2 minutes - VV_AUT_2_ it is possible to obtain a **good** estimator of $V_{3600}$, and from _instantateous wind velocity each 10 minutes - VV_AUT_10_ it is possible to obtain a **poor** estimator of $V_{3600}$. 


### Data Comparison

The available IDEAM data allowed two comparison processes, with quality data for a few stations, and with low quality data, but available for all stations. 

In both cases, to make the use of ISD and ERA5 viable, its time series are expected to be as similar as possible to IDEAM (field measurements). To verify this, two types of graphics were constructed:

1. **Time series overlay** for the three sources. Not very effective method due to the large amount of data that makes the graphics unreadable.

2. **Scatter plot graphics** comparing two different sources. Matching values by time, were sorted in ascending order, and put together on a scatter plot. The expected behavior in case of similarity in the data, is that all the points fall in a $45^\circ$ line


#### IDEAM VV_AUT_2 - Quality Data Comparison 

IDEAM VV_AUT_2 was available for twenty (20) stations, of which only twelve (12) were _perfectly equivalent_ to ISD stations, see table \@ref(tab:table12stations), and map in left panel of figure \@ref(fig:qualitycomparison1). VV_AUT_2 dataset was transformed to $V_{3600}$ (average hourly speed), averaging all 20 values available per hour. For twelve matching  stations, wind velocity $V_{3600}$ (transformation of VV_AUT_2), was standardized station by station, using procedure described in [Surface Roughness at Open Space](#rmd-roughness) section and [Averaging Time 3-s Gust](#rmd-gust), and finally, for the same twelve ISD and IDEAM standardized stations, a comparison was done against matching ERA5 stations (the corresponding cell in ERA5 that has within ISD and IDEAM locations).

```{r table12stations, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
#data_sources_thesis_summary1 <-read.csv("./data/data_sources_thesis_summary1.csv",header=TRUE, stringsAsFactors = F)
stationssample = data.frame(
  ISD_ID= as.character(
    c(803980, 803700, 802110, 802100, 801120, 801100, 800970, 800940, 800630, 800360, 800350, 800280)), 
  IDEAM_ID = as.character(
    c(48015050, 52055230, 26125061, 26125710, 23085270, 27015330, 16015501, 23195502, 13035501, 28025502, 15065180, 29045190)),  
  stringsAsFactors=FALSE)
stationssamplewithera5 = data.frame(
  ISD_ID= as.character(
    c(803980, 803700, 802110, 802100, 801120, 801100, 800970, 800940, 800630, 800360, 800350, 800280)), 
  IDEAM_ID = as.character(
    c(48015050, 52055230, 26125061, 26125710, 23085270, 27015330, 16015501, 23195502, 13035501, 28025502, 15065180, 29045190)),
  ERA5_STATION = c(
           "3320, (37, 68), [−70, −4.25]",
           "2309, (6, 48), [−77.75, 0.75]",
           "1582, (14, 33), [−75.75, 4.5]",
           "1533, (14, 32), [−75.75, 4.75",
           "1240, (15, 26), [−75.5, 6.25]",
           "1240, (15, 26), [−75.5, 6.25]",
           "909, (27, 19), [−72.5, 8]",
           "1102, (24, 23), [−73.25, 7]",
           "749, (14, 16), [−75.75, 8.75]",
           "416, (24, 9), [−73.25, 10.5]",
           "221, (25, 5), [−73, 11.5]",
           "312, (18, 7), [−74.75, 11]"
           ),
  stringsAsFactors=FALSE)
kable(stationssamplewithera5, align=rep('l', 3),
      col.names = c("ISD ID", "IDEAM ID", "ERA5 ID, (col,row), [lon,lat]"),
      caption = "Quality Data Comparison",
      caption.short = "quality",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "0.6in") %>%
      column_spec(2,width = "0.6in") %>%
      column_spec(3,width = "1.8in") %>%
kable_styling(font_size = 10, latex_options="scale_down")
```



```{r qualitycomparison1, message=FALSE, warning=FALSE, include=FALSE}

con1 = src_postgres(dbname = "winddata", host = "localhost", port = 5432, user = "user1", password = "user1")

#Get Ideam Stations Table
originalfields4 = c("objectid", "codigo1", "nombre", "latitud", "longitud", "latitud", "longitud", "categoria")
newnames4 = c("objectid", "codigo1", "nombre", "latitud", "longitud", "y", "x", "categoria")
originalfields4 = paste(originalfields4, " as ", newnames4, sep="")

originalfields4 = paste(originalfields4, collapse= ", ", sep = "")
#query4 = paste("select", originalfields4, "from ideam_all_stations", "where inpqrs2 = 'YES'", sep=" ")
query4 = paste("select", originalfields4, "from ideam_all_stations", "where codigo1 IN (48015050, 52055230, 26125061, 26125710, 23085270, 27015330, 16015501, 23195502, 13035501, 28025502, 15065180, 29045190)", sep=" ")
ideam_stations = as_tibble(tbl(con1, sql(query4)))
Encoding(ideam_stations$categoria) <- "UTF-8"
Encoding(ideam_stations$nombre) <- "UTF-8"
originalfields3 = c("id", "usaf", "station_name", "latitud", "longitud", "latitud", "longitud")
newnames3 = c("id", "usaf", "station_name", "latitud", "longitud", "y", "x")
originalfields3 = paste(originalfields3, " as ", newnames3, sep="")
originalfields3 = paste(originalfields3, collapse= ", ", sep = "")
#query3 = paste("select", originalfields3, "from isd_all_stations where usaf_isd_dataua != ''", sep=" ")
query3 = paste("select", originalfields3, "from isd_all_stations where usaf IN ('803980', '803700', '802110', '802100', '801120', '801100', '800970', '800940', '800630', '800360', '800350', '800280')", sep=" ")

isd_stations = as_tibble(tbl(con1, sql(query3)))


ideam_stations = st_as_sf(ideam_stations, coords = c("longitud", "latitud"), crs = 4326)
isd_stations = st_as_sf(isd_stations, coords = c("longitud", "latitud"), crs = 4326)

ideam_stations3 <- ideam_stations %>% filter(codigo1 %in% c(15065180, 29045190, 28025502)) 

ideam_stationso <- ideam_stations %>% filter(codigo1 %in% c(48015050, 52055230, 26125061, 26125710, 23085270, 27015330, 16015501, 23195502, 13035501))

isd_stations3 <- isd_stations %>% filter(usaf %in% c('800350', '800280', '800360'))

isd_stationso <- isd_stations %>% filter(usaf %in% c('803980', '803700', '802110', '802100', '801120', '801100', '800970', '800940', '800630'))


file_era5_st = "./data/era5grid_left_right.tif"
era5_4326_st = read_stars(file_era5_st)
era5_4326_st = setNames(era5_4326_st, "Station")

file_col_st = "./data/col2.tif"
col_4326_st = read_stars(file_col_st)
col_4326_st = setNames(col_4326_st, "col_4326_st")

file_era5_sf_point = "./data/era5grid_left_right.shp"
era5_4326_sf_point = st_read(dsn=file_era5_sf_point)

file_era5_sf_pol = "./data/era5grid_left_right_pol.shp"
era5_4326_sf_pol = st_read(dsn=file_era5_sf_pol)

file_col_sf_pol = "./data/COLOMBIA.shp"
col_4326_sf_pol = st_read(dsn=file_col_sf_pol)

img_stack_col=stack(file_col_st)
img_stack_col.crop = crop(img_stack_col, extent(col_4326_sf_pol))
img_stack_col.mask = mask(img_stack_col.crop, col_4326_sf_pol)
```


```{r qualitycomparison2, echo=FALSE, fig.cap="IDEAM VV_AUT_2 - Quality Data Comparison.", message=FALSE, warning=FALSE}

myPalette <- colorRampPalette(rev(brewer.pal(11, "YlGn")))
sc <- scale_fill_gradientn(colours = myPalette(100), limits=c(0, 255))


theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))


colombia = world_points$name == "Colombia"
panama = world_points$name == "Panama"
peru= world_points$name == "Peru"
brazil= world_points$name == "Brazil"
venezuela= world_points$name == "Venezuela"
ecuador= world_points$name == "Ecuador"

#Final map - predictions
k = era5_4326_sf_pol
#st_crs(k) = st_crs(3116)
#k = st_warp(k, crs=st_crs(4326))
#mid <- mean(k$var1.pred, na.rm = TRUE)

#myfilename = paste0("D:/jd/01 Códigos de programación/02 Ajuste con R/rasters/combinedok/", "combined_700.tif")
#write_stars(k, myfilename)


big <-ggplot(data = world) + 
  geom_sf(fill= "antiquewhite",  size=0.1) + 
  #geom_stars(data = col_4326_st[col_4326_sf_pol][,,,1], aes(fill = col_4326_st, x = x, y = y)) +
  #ggRGB(img_stack_col.mask, r = 1, g = 2, b = 3, ggLayer = TRUE)+
  #sc+
  #geom_sf(data = k, colour="black", fill=NA) + 
  #scale_fill_gradientn(colors = sf.colors(20)) + 
  #sc2 + 
  #sc+
  geom_text(data= world_points[venezuela,],aes(x=-68.5, y=8.5, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  geom_text(data= world_points[panama,],aes(x=-80.5, y=9.2, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) + 
  geom_text(data= world_points[ecuador,],aes(x=-78, y=-1, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  geom_text(data= world_points[peru,],aes(x=-75, y=-3.7, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  geom_text(data= world_points[brazil,],aes(x=-68, y=-2, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  geom_text(data= world_points[colombia,],aes(x=-71, y=4, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  annotate(geom = "text", x = -77.5, y = 14, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  annotate(geom = "text", x = -80.5, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
  geom_sf(data = st_cast(world, "MULTILINESTRING"), size=0.1)+
  geom_rect(mapping=aes(xmin=-73.7, xmax=-72.8, ymin=10.1, ymax=10.9), color="red", alpha=0, size=0.1) +
  geom_sf(data = ideam_stations, size=2, shape=23, color= "red", show.legend = "point") + 
  #geom_sf_text(data = ideam_stations, aes(label = codigo1), size=3, position = position_nudge(x = -1.5)) +
  geom_text_repel(data = ideam_stationso, size=2, aes(x=x, y=y, label = codigo1), direction="x", segment.size=0.1) +
  geom_text_repel(data = ideam_stations3, size=2, aes(x=x, y=y, label = codigo1), direction="x", segment.size=0.1, nudge_x=-0.5) +
  geom_sf(data = isd_stations, size=2, shape=3, color= "blue", show.legend = "point") +
  #geom_sf_text(data = isd_stations, aes(label = usaf), size=3, position = position_nudge(x = +1.5)) +
  geom_text_repel(data = isd_stationso, size=2, aes(x=x, y=y, label = usaf), direction="y", segment.size=0.1) +
  geom_text_repel(data = isd_stations3, size=2, aes(x=x, y=y, label = usaf), direction="x", segment.size=0.1, nudge_x=0.5) +
  #geom_sf_label(data = k, aes(label = DN), size=3) +
  #geom_sf(data = era5colpoints3116, size=1, shape=2, color= "black", show.legend = "point") + 
  annotation_scale(location = "bl", width_hint = 0.5, height = unit(0.2, "cm"), line_width = 0.5, text_cex = 0.5) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), height = unit(1, "cm"), width = unit(1, "cm"), style = north_arrow_fancy_orienteering) +
  coord_sf(xlim = c(-79.5, -66.5), ylim = c(-5.4, 12.3), expand = FALSE) +
  #coord_sf(xlim = c(-73.7, -72.8), ylim = c(10.1, 10.9), expand = FALSE) +
  xlab("") + 
  ylab("") + 
  ggtitle("Quality Data Comparison\nTwelve matching stations from IDEAM and ISD") + 
  theme(plot.title = element_text(size=8)) +
  theme(axis.text.x= element_text(size=7)) + 
  theme(axis.text.y= element_text(size=7)) +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1)) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  #theme(legend.title = element_text(size=8)) +
  #theme(legend.text=element_text(size=8)) +
  #theme(legend.key.size = unit(0.5,"line")) +
  theme(plot.margin=unit(c(0,0,0,0),"cm")) +
  #theme(plot.background = element_rect(color = "black"))+
  theme(axis.text.x = element_text(margin =  margin(t =2, b = -10))) + 
  theme(axis.text.y = element_text(margin =  margin(r =2, l = -10)))
  

small <- ggplot(data = world) + 
  geom_sf(fill= "antiquewhite",  size=0.1) + 
  #ggRGB(img_stack_col.mask, r = 1, g = 2, b = 3, ggLayer = TRUE)+
  #geom_stars(data = col_4326_st[col_4326_sf_pol][,,,1], aes(fill = col_4326_st, x = x, y = y)) +
  #sc+
  geom_sf(data = k, colour="black", fill=NA, size=0.1) + 
  #scale_fill_gradientn(colors = sf.colors(20)) + 
  #sc2 + 
  #sc+
  geom_text(data= world_points[venezuela,],aes(x=-66.5, y=8.5, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[panama,],aes(x=-80.5, y=9.2, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) + 
  geom_text(data= world_points[ecuador,],aes(x=-79.2, y=-1, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[peru,],aes(x=-75, y=-6, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[brazil,],aes(x=-68, y=-6, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  geom_text(data= world_points[colombia,],aes(x=-71, y=4, label=name), color = "darkblue", fontface = "bold", size=3, check_overlap = FALSE) +
  annotate(geom = "text", x = -77.5, y = 14, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  annotate(geom = "text", x = -80.5, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
  geom_sf(data = st_cast(world, "MULTILINESTRING"),  size=0.1)+
  geom_sf(data = ideam_stations, size=3, shape=23, color= "red", show.legend = "point") + 
  geom_sf_text(data = ideam_stations, aes(label = codigo1), size=2, position = position_nudge(x = -0.11)) +
  geom_sf(data = isd_stations, size=3, shape=3, color= "blue", show.legend = "point") +
  geom_sf_text(data = isd_stations, aes(label = usaf), size=2, position = position_nudge(x = +0.09)) +
  geom_sf_label(data = k, aes(label = DN), size=2) +
  #geom_sf(data = era5colpoints3116, size=1, shape=2, color= "black", show.legend = "point") + 
  annotation_scale(location = "bl", width_hint = 0.5, height = unit(0.2, "cm")) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), height = unit(1, "cm"), width = unit(1, "cm"), style = north_arrow_fancy_orienteering) +
  #coord_sf(xlim = c(-82.1, -63.8), ylim = c(-7.5, 15.5), expand = FALSE) +
  coord_sf(xlim = c(-73.7, -72.8), ylim = c(10.1, 10.9), expand = FALSE) +
  xlab("") + 
  ylab("") + 
  ggtitle("Quality Data Comparison\nStations 28025502 from IDEAM, \n800360 from ISD, and 416 from ERA5") +
  theme(plot.title = element_text(size=8)) +
  theme(axis.text.x= element_text(size=7)) + 
  theme(axis.text.y= element_text(size=7)) + 
  theme(panel.border = element_rect(colour = "red"))+
  #theme(plot.background = element_rect(color = "black")) +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"))

grid.arrange(big, small, ncol=2)
#grid.rect(gp=gpar(fill=NA))
```

The stations described in each row of the previous table \@ref(tab:table12stations), were compared by generating scatter plots and common time series graphics. Stations 28025502 from IDEAM, 800360 from ISD, and 416 (cell with center point in $-73.25^\circ$ longitude, and $10.5^\circ$ latitude) from ERA5, see map in right panel of figure \@ref(fig:qualitycomparison2), showed high correspondence, see figure \@ref(fig:sideamera5), because green regression line (empirical) is very similar to $45^\circ$ line (theoretical). Unfortunately, in the other eleven stations, there was no high equivalence between sources.


```{r sideamera5, echo=FALSE, fig.align="center", fig.cap="Quality Data Comparison. High similarity between sources", message=FALSE, warning=FALSE, fig.width=4, fig.height=3}
#saveRDS(comparison13, "data/comparison13.rds")
dat1 <- readRDS("data/comparison13.rds")
dat1
#box(which = "plot", col="black")
#include_graphics(path = "figure/s800360_ideam_vs_era5.png")
```


#### IDEAM VV_AUT_10 - Non Quality Data Comparison (available in all IDEAM stations)

VV_AUT_10 was available for 204 stations, and despide that $V_{3600}$ calculated from this source, is not an accurate or quality estimator, the standarization procedure was done to allow an additional comparison process, whose results are shown in the map displayed in figure \@ref(fig:poorcomparison). Downscaling support was 'Good' comparing IDEAM and/or ISD stations with twenty-three (23) ERA5 stations (2261, 1971, 2066, 2020, 2260, 1875, 2213, 2637, 1442, 1583, 1501, 1582, 1381, 1493, 1485, 1397, 1338, 1055, 511, 1644, 515, 221, 1038), and 'Very Good' comparing IDEAM and/or ISD with five (5) ERA5 stations (265, 360, 78, 312, 416).

'Very Good' downscaling results for this non quality data comparison, are shown bellow: 

* Table \@ref(tab:tableverygood), shows in each row compared stations. 

* Figure \@ref(fig:verygoodxts), shows an example of a very good time series plot for the ERA5 station 78 vs IDEAM stations 15075501 and 15079010. 

* Figure \@ref(fig:verygood), shows four different very good scatter plots, a) IDEAM 15015120 vs ERA5 265, b) IDEAM 29004520 vs ERA5 312, c) IDEAM 15079010 vs ERA5 78, and d) IDEAM 15075501 vs ERA5 78. Red line in each graphic represent the desired $45^\circ$ line, where all points should fall, if the data sources would be exactly the same (theoretical behavior when there is equivalence of sources), and green line represents the linear regression line (empirical or real behavior when making the comparison).
 

```{r poorcomparison, echo=FALSE, fig.cap="IDEAM VV_AUT_10 - Non Quality Data Comparison. Two different types of downscaling support: 'Good' and 'Very Good'", message=FALSE, warning=FALSE}

myPalette <- colorRampPalette(rev(brewer.pal(11, "YlGn")))
sc <- scale_fill_gradientn(colours = myPalette(100), limits=c(0, 255))

theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))

colombia = world_points$name == "Colombia"
panama = world_points$name == "Panama"
peru= world_points$name == "Peru"
brazil= world_points$name == "Brazil"
venezuela= world_points$name == "Venezuela"
ecuador= world_points$name == "Ecuador"


pts <- do.call(rbind, st_centroid(st_geometry(era5_4326_sf_pol)))
x = pts[,1]
y = pts[,2]

era5_4326_sf_pol$x = x
era5_4326_sf_pol$y = y

era5_4326_sf_pol_filter_good = era5_4326_sf_pol %>% filter(DN %in% c(2261, 1971,2066,2020,2260,1875,2213,2637,1442,1583,1501,1582,1381,1493,1485,1397,1338,1055,511,1644,515,221,1038))

era5_4326_sf_pol_filter_very_good = era5_4326_sf_pol %>% filter(DN %in% c(265,360,78,312,416))

era5_4326_sf_pol_col1 = era5_4326_sf_pol %>% filter(DN %in% c(1, 50, 148, 246, 344, 442, 540, 638, 736, 834, 932, 1030, 1128, 1226, 1324, 1422, 1520, 1618, 1716, 1814, 1912, 2010, 2108, 2206, 2304, 2402, 2500, 2598, 2696, 2794, 2892, 2990, 3088, 3186, 3284, 3333))

era5_4326_sf_pol_col49 = era5_4326_sf_pol %>% filter(DN %in% c(49, 147, 245, 343, 441, 539, 637, 735, 833, 931, 1029, 1127, 1225, 1323, 1421, 1519, 1617, 1715, 1813, 1911, 2009, 2107, 2205, 2303, 2401, 2499, 2597, 2695, 2793, 2891, 2989, 3087, 3185, 3283, 3381))

ggplot(data = world) + 
  geom_sf(fill= "antiquewhite",  size=0.1, alpha=0.7) + 
  #geom_stars(data = col_4326_st[col_4326_sf_pol][,,,1], aes(fill = col_4326_st, x = x, y = y)) +
  ggRGB(img_stack_col.mask, r = 1, g = 2, b = 3, ggLayer = TRUE, alpha=0.8)+
  sc+
  geom_sf(data = era5_4326_sf_pol, colour="grey", fill=NA, size=0.1) + 
  geom_sf(data = era5_4326_sf_pol_filter_good, aes(fill = "Good: 23"), colour="black", size=0.1, alpha=1, show.legend = "polygon") +
  geom_sf(data = era5_4326_sf_pol_filter_very_good, aes(fill = "Very Good: 5"), colour="black", size=0.1, alpha=1, show.legend = "polygon") +
  scale_fill_manual(values = c("Good: 23" = "yellow", "Very Good: 5" = "orange"), name="Downscaling Support") + #, label=c("dd")) +  
  #scale_fill_gradientn(colors = sf.colors(20)) + 
  #sc2 + 
  #sc+
  #geom_text(data= world_points[venezuela,],aes(x=-68.5, y=8.5, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  #geom_text(data= world_points[panama,],aes(x=-80.5, y=9.2, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) + 
  #geom_text(data= world_points[ecuador,],aes(x=-78, y=-1, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  #geom_text(data= world_points[peru,],aes(x=-75, y=-3.7, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  #geom_text(data= world_points[brazil,],aes(x=-68, y=-2, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  #geom_text(data= world_points[colombia,],aes(x=-71, y=4, label=name), color = "darkblue", fontface = "bold", size=2, check_overlap = FALSE) +
  #annotate(geom = "text", x = -77.5, y = 14, label = "Caribbean\nSea", fontface = "italic", color = "grey22", size = 4) + 
  #annotate(geom = "text", x = -80.5, y = 5, label = "Pacific\nSea", fontface = "italic", color = "grey22", size = 4) +
  geom_sf(data = st_cast(world, "MULTILINESTRING"), size=0.1)+
  #geom_rect(mapping=aes(xmin=-73.7, xmax=-72.8, ymin=10.1, ymax=10.9), color="red", alpha=0, size=0.1) +
  #geom_sf(data = ideam_stations, size=2, shape=23, color= "red", show.legend = "point") + 
  #geom_sf_text(data = ideam_stations, aes(label = codigo1), size=3, position = position_nudge(x = -1.5)) +
  geom_text_repel(data = era5_4326_sf_pol_col1, size=2, aes(x=x, y=y, label = DN), direction="y", segment.size=0.1, segment.color= "grey50", color="grey50", nudge_x=-1, hjust=1, box.padding=0.1) +
  geom_text_repel(data = era5_4326_sf_pol_col49, size=2, aes(x=x, y=y, label = DN), direction="y", segment.size=0.1, segment.color= "grey50", color="grey50", nudge_x=+1, hjust=0, box.padding=0.1) +
  #geom_sf(data = isd_stations, size=2, shape=3, color= "blue", show.legend = "point") +
  #geom_sf_text(data = isd_stations, aes(label = usaf), size=3, position = position_nudge(x = +1.5)) +
  #geom_text_repel(data = isd_stationso, size=2, aes(x=x, y=y, label = usaf), direction="y", segment.size=0.1) +
  #geom_text_repel(data = isd_stations3, size=2, aes(x=x, y=y, label = usaf), direction="x", segment.size=0.1, nudge_x=0.5) +
  #geom_sf_label(data = k, aes(label = DN), size=1) +
  #geom_sf(data = era5colpoints3116, size=1, shape=2, color= "black", show.legend = "point") + 
  #annotation_scale(location = "bl", width_hint = 0.5, height = unit(0.2, "cm"), line_width = 0.5, text_cex = 0.5) + annotation_north_arrow(location = "br", which_north = "true", pad_x = unit(0.05, "in"), pad_y = unit(0.05, "in"), height = unit(1, "cm"), width = unit(1, "cm"), style = north_arrow_fancy_orienteering) +
  coord_sf(xlim = c(-81.25, -64.75), ylim = c(-5, 13), expand = FALSE) +
  #coord_sf(xlim = c(-73.7, -72.8), ylim = c(10.1, 10.9), expand = FALSE) +
  xlab("") + 
  ylab("") + 
  ggtitle("ERA5 grid, cells IDs from 1 to 3381 (49 cols, 69 rows)\nISD-IDEAM-ERA5 'poor data' comparison") + 
  theme(plot.title = element_text(size=8)) +
  theme(axis.text.x= element_text(size=7)) + 
  theme(axis.text.y= element_text(size=7)) +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.1)) +
  theme(panel.background = element_rect(fill = "aliceblue")) +
  #theme(legend.title = element_text(size=8)) +
  #theme(legend.text=element_text(size=8)) +
  #theme(legend.key.size = unit(0.5,"line")) +
  theme(plot.margin=unit(c(0,0,0,0),"cm")) +
  #theme(plot.background = element_rect(color = "black"))+
  theme(axis.text.x = element_text(margin =  margin(t =2, b = -10))) + 
  theme(axis.text.y = element_text(margin =  margin(r =2, l = -10)))

#grid.rect(gp=gpar(fill=NA))  
```


```{r tableverygood, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
tableverygood <-read.csv("./data/poor_datasource_comparison_very_good_match.csv",header=TRUE, stringsAsFactors = F)

kable(tableverygood, align=rep('l', 3),
      col.names = c("ISD ID", "IDEAM ID", "ERA5: ID, (col,row), [lon,lat]"),
      caption = "Non quality data comparison. 'Very Good' downscaling support.",
      caption.short = "non-quality",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "0.6in") %>%
      column_spec(2,width = "0.6in") %>%
      column_spec(3,width = "1.8in") %>%
kable_styling(font_size = 10, latex_options="scale_down")
```

For some ISD stations in previous table \@ref(tab:tableverygood), the value 'NA' means that for the corresponding ERA5 and IDEAM station (same row), there is not a ISD station located inside the ERA5 cell space ($0.25^\circ * 0.25^\circ$).

```{r verygoodxts, echo=FALSE, fig.cap="Non Quality Data Comparison. Time Series Graphic for 'Very Good' Downscaling Support", message=FALSE, warning=FALSE, fig.height=3}
tl = readRDS(file="./data/eracomparisonideam_188_78_plotxts.rds")
#tr = readRDS(file="./data/eracomparisonideam_19812_416_plotzoo.rds")
tl
#box(which="figure")
```


```{r verygood, echo=FALSE, fig.cap="Non Quality Data Comparison: Scatter plots for 'Very Good' Downscaling Support", message=FALSE, warning=FALSE}
par(mfrow=c(3,2))
par(mar=c(0,0,0,0))
par(oma=c(0,0,0,0))

cl = readRDS(file="./data/eracomparisonideam_129_1_2_265_plotgg.rds")
cr = readRDS(file="./data/eracomparisonideam_195_1_2_312_plotgg.rds")
bl = readRDS(file="./data/eracomparisonideam_188_1_3_78_plotgg.rds")
br = readRDS(file="./data/eracomparisonideam_188_1_2_78_plotgg.rds")


#layout(matrix(c(1,2,3,4,5,6), 2, 3, byrow = TRUE))

#plot_grid(tl, tr, ncol = 2, labels=c("A", "B"), label_size = 7, label_colour = "red")#, 




# ggdraw() +
#    draw_plot(tl, 0, 0, 0.7, 1) +
#    draw_plot(tr, 0.7, 0.3, 0.3, 0.3)

#plot_grid(cl, cr, bl, br, ncol = 2, labels=c("C", "D", "E", "F"), label_size = 7, label_colour = "red")#,  align = c("hv")

plot_grid(cl, cr, bl, br, ncol = 2, labels=c("A", "B", "C", "D"), label_size = 7, label_colour = "red")#,  align = c("hv")

#grid.arrange(tl, tr, cl, cr, bl, br, ncol=2)


# ggdraw() +
#   draw_plot(tl, 0, 1, 0.7, .5) +
#   draw_plot(tr, 0.7, 1, 0.3, .5) +
#   draw_plot(cl, 0, .5, 0.5, .5) +
#   draw_plot(cr, 0.5, .5, 0.5, .5) +
#   draw_plot(bl, 0, 0, .5, .5) +
#   draw_plot(br, .5, 0, .5, .5) +
#   draw_plot_label(c("A", "B", "C", "D", "E", "F"), c(0, 0.7, 0, 0.5, 0, 0.5), c(1.5, 1.5, 1, 1, 0.5, 0.5), size = 7)
```


## POT-PP in ISD Station 801120

Figure \@ref(fig:station801120) shows the satellite image (source Google Earth) of ISD station 801120, located in the international airport 'José María Córdova', municipality of Rio Negro (Antioquia, Colombia), with latitud $6.125^\circ$, and longitud $-75.423^\circ$ WGS84 coordinates.  Red circle represents an influence radius of 800 meters. Table \@ref(tab:cf801120) shows different calculations related to correction factors applied to this station, using procedure described in sections [Surface Roughness at Open Space](#rmd-roughness), and [Averaging Time 3-s Gust](#rmd-gust).

```{r station801120, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Location of ISD station 801120", fig.align="center", dpi=420}
include_graphics(path = "figure/801120.jpg")
```



```{r cf801120, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
cf  = data.frame (Variable = c("Roughness - $Z_o$", "Empirical exponent - $\\alpha$", "Gradient height - $z_g$", "Exposure coefficient - $K_z$", "$F_{exposition}$", "Gust factor for $V_3$" ), Value=c(0.051, 8.38, 310.56, 0.88, 1.07, 1.03))

kable(cf, align=c('l', 'c'),  digits = c(1, 2), format = "latex", escape = FALSE,
      col.names = c("Variable", "Value"),
      caption = "Corrections factors for ISD station 801120",
      caption.short = "corrections factors",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "2in") %>%
      column_spec(2,width = "0.6in") %>%
      #column_spec(3,width = "1.8in") %>%
kable_styling(font_size = 10, latex_options="scale_down")
```

### Raw data, declustering, and thresholding

As storm information is not available for any of the data sources, all the data for the station was classified as *non-thunderstorm*. According to [POT-PP](#pot-pp) method described in [methodology](#rmd-method), the first process aplied to original time series -raw data-, is [declustering](#decluster), and then, [thresholding](#thresholding). 

Non-thunderstorm raw data for ISD station 801120 has `r sum(years_all$count)` records, from `r index(years_all)[1]` to `r index(years_all)[length(years_all$count)]`, corresponding to a total amount time in days of `r format(imp.vals$nt.length.time, scientific=F, digits = 0)`, and to an average number of events per year of `r round(imp.vals$n.nthunders.per.year, 1)`, which means that the average duration of an event is `r round(365/imp.vals$n.nthunders.per.year, 1)` days (average size in days of a cluster). After [declustering](#decluster), and [thresholding](#thresholding) processes, the number of records decreases to `r sum(years_declu_nt$count)`. Time series graphics are shown in figure \@ref(fig:ts), showing the data before (left) and after (right) applying the mentioned processes. Detailed yearly statistics are reported in table \@ref(tab:years801120), also including summary for before (left), and after (right). 

```{r years801120, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
#years_declu_nt
#years_all

labelyears_all = year(years_all)
years_all_1 = as.data.frame(years_all)
rownames(years_all_1) = labelyears_all

labelyears_declu_nt = year(years_declu_nt)
years_declu_nt_1 = as.data.frame(years_declu_nt)
rownames(years_declu_nt_1) = labelyears_declu_nt


years_both <- merge(years_all_1, years_declu_nt_1, by=0, all=TRUE, suffixes = c(".rd",".dc")) 

years_both$count.dc[is.na(years_both$count.dc)] <- 0  

#years1$Year = labelyears
kable(years_both, align=rep('l', 9),  digits = c(0,0,1,1,1,0,1,1,1), 
      col.names = c("Year", "Count", "Mean", "Min", "Max","Count", "Mean", "Min", "Max"),
      caption = "Yearly statistics of raw data and declustered data for ISD station 801120",
      caption.short = "yearly statistics",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "0.3in") %>%
      column_spec(2,width = "0.3in") %>%
      column_spec(3,width = "0.3in") %>%
      column_spec(4,width = "0.3in") %>%
      column_spec(5,width = "0.3in") %>%
      column_spec(6,width = "0.3in") %>%
      column_spec(7,width = "0.3in") %>%
      column_spec(8,width = "0.3in") %>%
      column_spec(9,width = "0.3in") %>%
      kable_styling(font_size = 9, latex_options="scale_down") %>%
      add_header_above(c(" ", "Raw Data" = 4, "Declustered Data" = 4))
```

It can be seen in the table \@ref(tab:years801120), that declustered data has zero records for some years. This situation is due to that all the data for each one of those years (2001, 2007, 2011, 2013, 2018, and 2019), belonged to a cluster that started the previous year, or finished the next year, and the unique chosen maximun value (the value representative for the cluster) was found in the previous or next year, but not in mentioned years of zero records.


```{r ts, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Non-Thunderstorm Time Series for ISD station 801120. Left: Raw Data. Right: Declustered Data",  fig.align="center", fig.height=2, fig.width=4.5}
plot_grid(myprint1, NULL, myprint5, ncol = 3,  rel_widths = c(1,0.26,1))
#grid.rect(gp=gpar(fill=NA))
#grid.arrange(myprint1, myprint5, ncol=2)
```

Using declustered data, and considering that it is only neccesary to calculate optimal threshold for non-thunderstorm data, because there is no records classified as thunderstorm in any data source, many non-thunderstomr thresholds were tested, to choose the best one using the W statistic, as described in section [thresholding](#thresholding) of the [methodology](#rmd-method). Figure \@ref(fig:page6) shows a very good fit in resulting W-Statistic plot, for optimal non-thunderstorm threshold $b_{nt} =$ _`r z5`_$\frac{Km}{h}$, with a maximun W distance of `r format(z8, scientific=F, digits = 2)`, for ISD station 801120, where empirical values (black points) are very close or similar to theoretical values (red line).


```{r page6, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="POT - Thresholding", size="footnotesize", fig.align="center", fig.width=2.5, fig.asp=1}
#replayPlot(myprint6)
dat <- readRDS("data/myprint6.rds")
dat
#lines(x=c(3.1, 3.1), y=c(3.1,3.8), col="green", lty=5)
#points(x=3.1, y=3.8, pch=".")
#text(x = 3.1, y = 3.4, labels = c("Minimum W-statistic distance"), cex=0.6, pos = 2)
#box(which = "plot", col="red")
#box(which = "figure", col="blue")
#box(which = "inner", col="cyan")
#box(which = "outer", col="orange")

```

### Fitted pdf and cdf and Goodness of Fit

Equation \@ref(eq:ppintensityfunction), defined in section [POT-PP](#method-pot-pp) of the [methodological framework](#rmd-thefra), was used as intensity function, $\lambda(t, y) = \lambda_{nt}(y)$, for POT-PP. When shape $\zeta_t$ is equal to zero, as it is in this study, an equivalent intensity function is described in equation \@ref(eq:ppspecificintensityfunction) defined in terrms of the parameters location ($\omega_t$), and scale ($\psi_t$). Related _pdf_ and _cdf_ functions are referenced in equations \@ref(eq:pppdf), where the domain $D$ constraint the data above the threshold _b_, and the time to a non-thunderstorm period, and \@ref(eq:ppcdf) respectively.

* Intensity function: $\frac{1}{\psi_{nt}}\exp\left(\frac{-(y-\omega_{nt})}{\psi_{nt}}\right)$

* pdf: $f(t,y) = \frac{\lambda(t,y)}{\int_D\lambda(t,y)\,dt\,dy}$

* cdf: $F(t,y) = P(y \leq Y) = \frac{\int_b^Y\lambda(y,t)\,dy}{\int_b^\infty\lambda(y,t)\,dy}$

After fitting the instensity function to the domain $D$, the resulting parameters for ISD station 801120, are location $\omega_t$ equal to `r format(z6, scientific=F, digits = 4)`, and scale $\psi_t$ equal to `r format(z7, scientific=F, digits = 4)`. Figure \@ref(fig:page8) shows the histogram and fitted pdf in panel A, Q-Q plot (theoretical quantiles against empirical ones) in panel B,  empirical cumulative distribution against fitted cdf in panel C, and P-P plot (theoretical probabilities against empirical ones) in panel D. In all four panels, it can be seen that there is a very good visual correspondence between empirical data (points and histogram) and theoretical adjustment (lines). 


```{r page8, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Graphic Diagnosis Of Goodness of Fit. Station 801120", fig.align="center", fig.width=5, fig.height=4}
replayPlot(myprint8)
add_label <- function(xfrac, yfrac, label, pos = 4, ...) {
  
  u <- par("usr")
  x <- u[1] + xfrac * (u[2] - u[1])
  y <- u[4] - yfrac * (u[4] - u[3])
  text(x, y, label, pos = pos, ...)
}
par(xpd = TRUE)
add_label(-0.06, 0.01, "A", cex=0.6, col="red")
add_label(0.47, 0.01, "B", cex=0.6, col="red")
add_label(-0.06, 0.54, "C", cex=0.6, col="red")
add_label(0.47, 0.54, "D", cex=0.6, col="red")
```

Results of formal goodness of fit statistics for 'Kolmogorov-Smirnov D', 'Cramer-von Mises T' and 'Anderson-Darling A' are `r format(mygof$ks, scientific=F, digits = 2)`, `r format(mygof$cvm, scientific=F, digits = 2)`, and `r format(mygof$ad, scientific=F, digits = 3)` respectively. For a proposed null hypothesis, which indicates that the data conforms to a POT-PP, all resulting p-values using statistics D, T and A, confirm that there is no statistical evidence to to reject stated hypothesis. Resulting p-value for statistic D is `r format(mykstest$p.value, scientific=F, digits = 2)`. Another available criteria to measure the quality of the fitted process are  'Akaike's Information Criterion', and 'Bayesian Information Criterion', with values `r format(mygof$aic, scientific=F, digits = 5)`, and `r format(mygof$bic, scientific=F, digits = 5)` respectively. The Root Mean Square Error (RMSE), calculated using theoretical versus empirical cdf, is `r format(rmse, scientific=F, digits = 2)`.

```{r fitpp, eval=FALSE, fig.align="center", fig.cap="Graphic Diagnosis Of Goodness of Fit. Station 801120", fig.height=4, fig.width=5, message=FALSE, warning=FALSE, include=FALSE}
opar <- par(no.readonly = TRUE)
#par(opar)


plotpdf<-function(){
  par(pty='m')
  par(bg="white")
  #plot(fpnt, lwd=2, col="cadetblue3")
  par(mar=c(2,2,1,0))
  par(oma=c(0,0,0,0))
  par(mgp=c(1,0.4,0))
  denscomp(fpnt, lwd=0.5, cex=0.5, cex.main=0.6, cex.axis=0.5, cex.lab=0.5, tck=-0.02, addlegend = FALSE)
}

plotpdfqqplot<-function(){
  par(pty='m')
  par(bg="white")
  #plot(fpnt, lwd=2, col="cadetblue3")
  par(mar=c(2,2,1,0))
  par(oma=c(0,0,0,0))
  par(mgp=c(1,0.4,0))
  qqcomp(fpnt, lwd=0.5, cex=0.5, cex.main=0.6, cex.axis=0.5, cex.lab=0.5, tck=-0.02, addlegend = FALSE)
}

plotcdf<-function(){
  par(pty='m')
  par(bg="white")
  #plot(fpnt, lwd=2, col="cadetblue3")
  par(mar=c(2,2,1,0))
  par(oma=c(0,0,0,0))
  par(mgp=c(1,0.4,0))
  cdfcomp(fpnt, lwd=0.5, cex=0.5, cex.main=0.6, cex.axis=0.5, cex.lab=0.5, tck=-0.02, addlegend = FALSE)
}

plotppplot<-function(){
  par(pty='m')
  par(bg="white")
  #plot(fpnt, lwd=2, col="cadetblue3")
  par(mar=c(2,2,1,0))
  par(oma=c(0,0,0,0))
  par(mgp=c(1,0.4,0))
  ppcomp(fpnt, lwd=0.5, cex=0.5, cex.main=0.6, cex.axis=0.5, cex.lab=0.5, tck=-0.02, addlegend = FALSE)

}

z.plot1<-function(){plotpdf()}
z.plot2<-function(){plotpdfqqplot()}
z.plot3<-function(){plotcdf()}
z.plot4<-function(){plotppplot()}

plot_grid(z.plot1, z.plot2, z.plot3, z.plot4, ncol=2, labels=c("A", "B", "C", "D"), label_size = 7, label_colour = "red")

par(opar)

```


### Hazard Curve and Return Levels - RL

Hazard curve is the solution to equation \@ref(eq:pprl), but eliminating from it elements related to thunderstorms, the equation is simplified to  $A_{nt}\int_{Y_N}^{\infty}\lambda_{nt}\left( y\right)\,dy = \frac{1}{N}$, where $A_{nt}$ is the average time of non-thunderstorm events by year, and $Y_N$ is the return level or extreme wind velocity, corresponding to the N-years return period or MRI. Reemplacing in this ecuation the intensity function $lambda_{nt}$, and solving $Y_N$ for all possible values of MRI, will provide hazard curve displayed in figure \@ref(fig:page10).


```{r page10, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Hazard Curve. Station 801120" , fig.align="center", fig.height=2.5, fig.width=3.5}
#replayPlot(myprint10)
# library(RColorBrewer)
# cols <- brewer.pal(9,"Set1")
# maxy = max(veocitiesfortypicalreturnperiodsP) + 0.15*max(veocitiesfortypicalreturnperiodsP)
# plot(x= 1/paP, y=yvels, xlab="Return Periods (Years) - Poisson Process Intensity Function",
#      ylab="Velocities Km/h", main=paste("Declustered - Non-Thunderstorms - Hazard Curve", "\n", "Location=", round(z6,2), " Scale=", round(z7,2), "\n",
#      "Station:", number, sep=" "),
#      xlim=c(0,8500), ylim=c(100, maxy), type="l", col=cols[3], lwd=3)
# 
# points(x= tipicalReturnPeriods, y= veocitiesfortypicalreturnperiodsP, col=cols[9], pch=20)
# text(x = tipicalReturnPeriods, y = veocitiesfortypicalreturnperiodsP, labels = paste0("(",tipicalReturnPeriods,",",round(veocitiesfortypicalreturnperiodsP, digits=1),")"), cex=0.8, pos = 4)
# mtext(side = 1, text = paste0("Page ", numberofplots), outer = TRUE)
# legend("bottomright", c("POT-PP (Intensity Function)"),
#        bty = "n",
#        col = cols[3:3],
#        lty = c(1), lwd = c(3),
#        pch = c(NA),
#        pt.bg = c(NA),
#        pt.cex = c(0))
# box(lty = 1, col = 'black', lwd=0.5)
  
library(ggplot2)
x= 1/paP 
y= yvels
df = data.frame(x = x, y = y)

x1= tipicalReturnPeriods
y1= veocitiesfortypicalreturnperiodsP

df2 = data.frame(x = x1, y = y1)
library(dplyr)
df2_more1700 <- df2 %>% filter(x >= c(1700))
df2_less1700 <- df2 %>% filter(x < c(1700))

ggplot(data=df, aes(x=x, y=y, group=1)) +
  geom_line(color="red")+
  geom_point(data=df2, aes(x=x, y=y, group=1), shape = 18, color = "black", fill="lightgray") +
  xlim(0,8500) + 
  ylim(125, 300) +
  geom_text_repel(data=df2_more1700, size=2, aes(x=x, y=y, label = paste0("(",x,",",round(y, digits=1),")")),  direction="y", segment.size=0.1, nudge_y=15) + # ,
  geom_text_repel(data=df2_less1700, size=2, aes(x=x, y=y, label = paste0("(",x,",",round(y, digits=1),")")),  direction="x", segment.size=0.1, nudge_x=1) +
  xlab("Return Periods (Years) - POT-PP Intensity Function") + 
  ylab("Velocities Km/h") + 
  ggtitle(paste("Declustered - Non-Thunderstorms - Hazard Curve", "\n", "Location=", round(z6,2),  "Scale=", round(z7,2))) + 
  theme(plot.title = element_text(size=8)) +
  theme(axis.text.x= element_text(size=6)) + 
  theme(axis.text.y= element_text(size=6)) +
  theme(axis.title =element_text(size=7))
```


```{r rl, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
mdf = data.frame(MRI=tipicalReturnPeriods, RL=veocitiesfortypicalreturnperiodsP)

kable(mdf, align=c('l', 'c'),  digits = c(1, 2),
      col.names = c("MRI", "Return Level"),
      caption = "Return Levels -RL for typical Mean Return Intervals - MRI. ISD station 801120",
      caption.short = "RL",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "0.3in") %>%
      column_spec(2,width = "0.7in") %>%
      #column_spec(3,width = "1.8in") %>%
kable_styling(font_size = 10, latex_options="scale_down")

```

Return levels of interest for this research, corrrespond to 700, 1700 and 3000 years of MRI, however, due to the mechanism of [integration with existing hurricane study information](#integration), described in [methodology](#rmd-method), it is necessary to extract for all stations values related to typical return periods, as shown in the table \@ref(tab:rl).

### Comparison with POT-GPD and common extreme value distributions

To enable a comparison between, a) POT-PP (previous section), b) [POT-GPD](#pot-gpd), and c) the fitting process of common extreme value distributions (GPA, GEV, GUM) without using POT method, this is, using the generic concept of [hazard function _hf_](#hf) (see [theoretical framework](#rmd-thefra)), a whole authomatation process was done to calculate return levels and errors using mentioned alternatives, bearing in mind that in all cases _maximum likelihood_ was used to calculate the parameters.

Resulting return levels and errors for POT-GPD, using R packages extRemes (@Gilleland2019), ismev (@JanetE.HeffernanwithRport2018), evd (@Stephenson2002), Renext (@Deville2016), evir (@Pfaff2018), and fExtremes (@Wuertz2017), are reported in table \@ref(tab:comparisonGPD). Similarty are shown it table \@ref(tab:comparisonCommonEVD), return levels calculated from the adjustment of the probability distributions GPA, GEV, and Gumbel.


```{r comparisonGPD, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
#years_declu_nt
#years_all


mydf_b = cbind(dlf$returnlev[c(28:33,35), ], RMSE=d$quant[c(28:33,35), 12])
rownames(mydf_b) = c("extRemes", "ismev", "evd", "Renext Renouv", "evir", "fExtremes", "Renext 2 parameters")

#years1$Year = labelyears
kable(mydf_b, align=rep('l', 12),  digits = c(rep(1, 11),3), 
      col.names = c("10", "20", "50", "100", "250","500", "700", "1000", "1700", "3000", "7000", "RMSE"),
      caption = "POT-GPD. Return Levels in Kph",
      caption.short = "POT-GPD",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "1.2in") %>%
      column_spec(2,width = "0.2in") %>%
      column_spec(3,width = "0.2in") %>%
      column_spec(4,width = "0.2in") %>%
      column_spec(5,width = "0.2in") %>%
      column_spec(6,width = "0.2in") %>%
      column_spec(7,width = "0.2in") %>%
      column_spec(8,width = "0.2in") %>%
      column_spec(9,width = "0.2in") %>%
      column_spec(10,width = "0.2in") %>%
      column_spec(11,width = "0.2in") %>%
      column_spec(12,width = "0.2in") %>%
      column_spec(13,width = "0.2in") %>%
      kable_styling(font_size = 8, latex_options="scale_down") %>%
      add_header_above(c("PACKAGE" = 1, "RETURN LEVELS FOR TYPICAL MRIs" = 11, "ERROR" = 1))
```


```{r comparisonCommonEVD, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE, results="asis"}
#years_declu_nt
#years_all


mydf_c = cbind(dlf$returnlev[c(3,10,12), ], RMSE=d$quant[c(3,10,12), 12])
evd_name = c("Generalized Pareto", "Generalized Extreme Value", "Gumbel")
mydf_c = cbind(evd_name, mydf_c)
#years1$Year = labelyears
kable(mydf_c, align=rep('l', 13),  digits = c(0, rep(1, 11),3), 
      col.names = c("NAME", "10", "20", "50", "100", "250","500", "700", "1000", "1700", "3000", "7000", "RMSE"),
      caption = "Common Extreme Value Distributions. Return Levels in Kph",
      caption.short = "CommonEVD",
      longtable = TRUE,
      booktabs = TRUE) %>%
      row_spec(0, align = "l") %>%
      column_spec(1,width = "0.1in") %>%
      column_spec(2,width = "1.4in") %>%
      column_spec(3,width = "0.15in") %>%
      column_spec(4,width = "0.15in") %>%
      column_spec(5,width = "0.15in") %>%
      column_spec(6,width = "0.15in") %>%
      column_spec(7,width = "0.15in") %>%
      column_spec(8,width = "0.15in") %>%
      column_spec(9,width = "0.15in") %>%
      column_spec(10,width = "0.15in") %>%
      column_spec(11,width = "0.15in") %>%
      column_spec(12,width = "0.15in") %>%
      column_spec(13,width = "0.15in") %>%
      column_spec(14,width = "0.15in") %>%
      kable_styling(font_size = 8, latex_options="scale_down") %>%
      add_header_above(c("EVD" = 2, "RETURN LEVELS FOR TYPICAL MRIs" = 11, "ERROR" = 1))
```

## Non-Hurricane Maps

### ISD

#### POT-PP

#### POT-GPD

### ERA5

#### POT-PP

#### POT-GPD


## Hurricane and Non-Hurricane Maps

### ISD

#### POT-PP

#### POT-GPD

### ERA5

#### POT-PP

#### POT-GPD


